<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>supla-device: SUPLA project</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">supla-device
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">SUPLA project </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_readme"></a></p>
<p><a href="https://www.supla.org">SUPLA</a> is an open source project for home automation.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Documentation</h1>
<p>Documentation is available <a href="https://supla.github.io/supla-device/">here</a>. Disclaimer: This is only a draft and work in progress.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
SuplaDevice library</h1>
<p>This repository contain SuplaDevice libraray. It allows to implement software for devices which connect to Supla infrastructure.</p>
<p>SuplaDevice can be used as library for Arduino IDE, or can be used directly with <a href="https://github.com/espressif/ESP8266_RTOS_SDK">ESP8266 RTOS SDK</a> and with <a href="https://github.com/espressif/esp-idf">ESP IDF</a>. It is also possible to compile and run it on Linux and in FreeRTOS environment, however here many functions are still missing.</p>
<p>Please check our changelog.</p>
<p>Below you can find basic infomration about SuplaDevice and instrutions for Arudino IDE.</p>
<h2><a class="anchor" id="autotoc_md3"></a>
Hardware requirements</h2>
<h3><a class="anchor" id="autotoc_md4"></a>
Arduino Mega</h3>
<p>SuplaDevice works with Arduino Mega boards. Arduino Uno is not supported because of RAM limitations. It should work on other Arduino boards with at least 8 kB of RAM. Following network interfaces are supported:</p><ul>
<li>Ethernet Shield with W5100 chipset</li>
<li>ENC28J60 (not recommended - see Supported hardware section)</li>
</ul>
<p>Warning: WiFi shields are currently not supported.</p>
<h3><a class="anchor" id="autotoc_md5"></a>
ESP8266 and ESP8285</h3>
<p>ESP8266 and ESP8285 boards are supported. Network connection is done via WiFi.</p>
<h3><a class="anchor" id="autotoc_md6"></a>
ESP32</h3>
<p>ESP32 boards are supported with connection via WiFi or via Ethernet.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
SuplaDevice library installation for Arduino IDE</h2>
<p>SuplaDevice is a library for <a href="https://www.arduino.cc/en/main/software">Arduino IDE</a> that allows to implement devices working with <a href="https://www.supla.org">Supla</a>.</p>
<p>Please use library manager in Arduino IDE to install newest SuplaDevice library.</p>
<p>Before you start, you will need to:</p><ol type="1">
<li>install Arduino IDE,</li>
<li>install support for your board</li>
<li>install driver for your USB to serial converter device (it can be external device, or build in on your board)</li>
<li>make sure that communication over serial interface with your board is working (i.e. check some example Arduino application)</li>
<li>download and install this librarary</li>
</ol>
<p>Above steps are standard Arudino IDE setup procedures not related to SuplaDevice library. You can find many tutorials on Internet with detailed instructions. Tutorials doesn't have to be related in any way with Supla.</p>
<p>After step 5 you should see Supla example applications in Arduino IDE examples. Select one and have fun! Example file requires adjustments before you compile them and upload to your board. Please read all comments in example and make proper adjustments.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
Usage</h2>
<h3><a class="anchor" id="autotoc_md9"></a>
Network interfaces</h3>
<p>Supported network interfaces for Arduino Mega:</p><ul>
<li>Ethernet Shield - with W5100 chipset. Include <code>&lt;<a class="el" href="ethernet__shield_8h_source.html">supla/network/ethernet_shield.h</a>&gt;</code> and add <code><a class="el" href="classSupla_1_1EthernetShield.html">Supla::EthernetShield</a> ethernet;</code> as a global variable.</li>
<li>ENC28J60 - it requires additional EthernetENC library. Include <code>&lt;<a class="el" href="ENC28J60_8h_source.html">supla/network/ENC28J60.h</a>&gt;</code> and add <code><a class="el" href="classSupla_1_1ENC28J60.html">Supla::ENC28J60</a> ethernet;</code> as a global variable. Warning: network initialization on this library is blocking. In case of missing ENC28J60 board or some other problem with network, program will stuck on initialization and will not work until connection is properly esablished. Second warning: UIPEthernet library is consuming few hundred of bytes of RAM memory more, compared to standard Ethernet library.</li>
</ul>
<p>Supported network interface for ESP8266:</p><ul>
<li>There is a native WiFi controller. Include <code>&lt;<a class="el" href="esp__wifi_8h_source.html">supla/network/esp_wifi.h</a>&gt;</code> and add <code><a class="el" href="classSupla_1_1ESPWifi.html">Supla::ESPWifi</a> wifi(ssid, password);</code> as a global variable and provide SSID and password in a constructor. Warning: by default connection with Supla server is encrypted. Default settings of SSL consumes big amount of RAM. To disable SSL connection, use: <code>wifi.enableSSL(false);</code></li>
</ul>
<p>SSL certificate verification. If you specify Supla's server certificate thumbprint there will be additional verification proceeded. Please use this method to configure fingerprint for validation: &lsquo;wifi.setServersCertFingerprint("9ba818295ec60652f8221500e15288d7a611177");&rsquo;</p>
<p>Supported network interface for ESP32:</p><ul>
<li>There is a native WiFi controller. Include <code>&lt;<a class="el" href="esp__wifi_8h_source.html">supla/network/esp_wifi.h</a>&gt;</code> and add <code><a class="el" href="classSupla_1_1ESPWifi.html">Supla::ESPWifi</a> wifi(ssid, password);</code> as a global variable and provide SSID and password in a constructor.</li>
</ul>
<h3><a class="anchor" id="autotoc_md10"></a>
Exmaples</h3>
<p>Each example can run on Arduino Mega, ESP8266, or ESP32 board - unless mentioned otherwise in comments. Please read comments in example files and uncomment proper library for your network interface.</p>
<h3><a class="anchor" id="autotoc_md11"></a>
Folder structure</h3>
<ul>
<li><code>supla-common</code> - Supla protocol definitions and structures. There are also methods to handle low level communication with Supla server, like message coding, decoding, sending and receiving. Those files are common with <code>supla-core</code> and the same code is run on multiple Supla platforms and services</li>
<li><code>supla/network</code> - implementation of network interfaces for supported boards</li>
<li><code>supla/sensor</code> - implementation of Supla sensor channels (thermometers, open/close sensors, etc.)</li>
<li><code>supla/storage</code> - implementation of persistant storage interfaces used by some Elements (i.e. keeping impulse counter data)</li>
<li><code>supla/control</code> - implementation of Supla control channels (various combinations of relays, buttons, action triggers)</li>
<li><code>supla/clock</code> - time services used in library (i.e. RTC)</li>
<li><code>supla/conditions</code> - classes that are used to check runtime dependencies between channels (i.e. turn on relay when humidity is below 40%)</li>
<li><code>supla/device</code> - device maintanance functions (like status LED which informs about connection status)</li>
<li><code>supla/pv</code> - supported integrations with inverters used with photovoltaic</li>
<li><code>supla/protocol</code> - protocol layers implementation for Supla and MQTT</li>
<li><code>supla</code> - all common classes are defined in main <code>supla</code> folder. You can find there classes that create framework on which all other components work.</li>
</ul>
<p>Some functions from above folders have dependencies to external libraries. Please check documentation included in header files.</p>
<h3><a class="anchor" id="autotoc_md12"></a>
How does it work?</h3>
<p>Everything that is visible in Supla (in Cloud, on API, mobile application) is called "channel". Supla channels are used to control relays, read temperature, check if garage door is open.</p>
<p>SuplaDevice implements support for channels in <code><a class="el" href="classChannel.html">Channel</a></code> and <code>ChannelExtended</code> classes. Instances of those classes are part of objects called <code>Element</code> which are building blocks for any SuplaDevice application.</p>
<p>All sensors, relays, buttons objects inherits from <code>Element</code> class. Each instance of such object will automatically register in SuplaDevice and proper virtual methods will be called by SuplaDevice in a specified way.</p>
<p>All elements have to be constructed before <code>SuplaDevice.begin()</code> method is called.</p>
<p>Supla channel number is assigned to each elemement with channel in an order of creation of objects. First channel will get number 0, second 1, etc. Supla server will not accept registration of device when order of channels is changed, or some channel is removed. In such case, you should remove device from Supla Cloud and register it again from scratch.</p>
<p><code>Element</code> class defines follwoing virtual methods that are called by SuplaDevice:</p><ol type="1">
<li><code>onLoadConfig</code> - called first within <code>SuplaDevice.begin()</code> method. It reads element configuration from <a class="el" href="classSupla_1_1Config.html">Supla::Config</a> instance.</li>
<li><code>onLoadState</code> - called second within <code>SuplaDevice.begin()</code> method. It reads element state data from persistent memory storage.</li>
<li><code>onInit</code> - called third within <code>SuplaDevice.begin()</code> method. It should initialize your element - all GPIO settings should be done there and proper state of channel should be set.</li>
<li><code>onSaveState</code> - called in <code>SuplaDevice.iterate()</code> - it saves state data to persistant storage. It is not called on each iteration. <code>Storage</code> class makes sure that storing to memory does not happen too often and time delay between saves depends on implementation.</li>
<li><code>onRegistered</code> - called in <code>SuplaDevice.iterate()</code> - it is called after SuplaDevice is registered to Supla server.</li>
<li><code>iterateAlways</code> - called on each iteration of <code>SuplaDevice.iterate()</code> method, regardless of network/connection status. Be careful - some other methods called in <code>SuplaDevice.iterate()</code> method may block program execution for some time (even few seconds) - i.e. trying to establish connection with Supla server is blocking - in case server is not accessible, it will iterfere with <code>iterateAlways</code> method. So time critical functions should not be put here.</li>
<li><code>iterateConnected</code> - called on each iterateion of <code>SuplaDevice.iterate()</code> method when device is connected and properly registered in Supla server. This method usually checks if there is some new data to be send to server (i.e. new temperature reading) and sends it.</li>
<li><code>onTimer</code> - called every 10 ms after enabling in <code>SuplaDevice.begin()</code></li>
<li><code>onFastTimer</code> - called every 1 ms (0.5 ms in case of Arudino Mega) after enabling in <code>SuplaDevice.begin()</code></li>
</ol>
<h2><a class="anchor" id="autotoc_md13"></a>
How to migrate programs written in SuplaDevice libraray versions 1.6 and older</h2>
<p>For Arduino Mega applications include proper network interface header: </p><div class="fragment"><div class="line">// Choose proper network interface for your card:</div>
<div class="line">// Arduino Mega with EthernetShield W5100:</div>
<div class="line">#include &lt;supla/network/ethernet_shield.h&gt;</div>
<div class="line">// Ethernet MAC address</div>
<div class="line">uint8_t mac[6] = {0x00, 0x01, 0x02, 0x03, 0x04, 0x05};</div>
<div class="line">Supla::EthernetShield ethernet(mac);</div>
<div class="line">//</div>
<div class="line">// Arduino Mega with ENC28J60:</div>
<div class="line">// #include &lt;supla/network/ENC28J60.h&gt;</div>
<div class="line">// Supla::ENC28J60 ethernet(mac);</div>
</div><!-- fragment --><p>For ESP8266 based applications include wifi header and provide WIFI SSID and password: </p><div class="fragment"><div class="line">// ESP8266 based board:</div>
<div class="line">#include &lt;supla/network/esp_wifi.h&gt;</div>
<div class="line">Supla::ESPWifi wifi(&quot;your_wifi_ssid&quot;, &quot;your_wifi_password&quot;);</div>
</div><!-- fragment --><p>In case of ESP8266 remove all methods that defined network interface. They were usually added on the bottom of ino file, after end of loop() method, i.e.: </p><div class="fragment"><div class="line">// Supla.org ethernet layer</div>
<div class="line">    int supla_arduino_tcp_read(void *buf, int count) {</div>
<div class="line">...</div>
<div class="line">SuplaDeviceCallbacks supla_arduino_get_callbacks(void) {</div>
<div class="line">...</div>
</div><!-- fragment --><p>Remove also those lines: </p><div class="fragment"><div class="line">#define SUPLADEVICE_CPP</div>
<div class="line">WiFiClient client;</div>
</div><!-- fragment --><p> You may also remove all WIFI related includes from ino file.</p>
<p>Common instruction for all boards:</p>
<p>If you use local IP address, please provide it in constructor of your network inteface class, i.e.: </p><div class="fragment"><div class="line">Supla::EthernetShield ethernet(mac, localIp);</div>
</div><!-- fragment --><p>After that go to SuplaDevice.begin() method. Old code looked like this </p><div class="fragment"><div class="line">SuplaDevice.begin(GUID,              // Global Unique Identifier </div>
<div class="line">                  mac,               // Ethernet MAC address</div>
<div class="line">                  &quot;svr1.supla.org&quot;,  // SUPLA server address</div>
<div class="line">                  locationId,                 // Location ID </div>
<div class="line">                  locationPassword);          // Location Password</div>
</div><!-- fragment --><p> This method requires now different set of parameters: </p><div class="fragment"><div class="line">SuplaDevice.begin(GUID,              // Global Unique Identifier </div>
<div class="line">                  &quot;svr1.supla.org&quot;,  // SUPLA server address</div>
<div class="line">                  &quot;mail@address.pl&quot;,     // Email address</div>
<div class="line">                  AUTHKEY);          // Authentication key</div>
</div><!-- fragment --><p> What is different? Well, GUID and Supla server address it the same as previously. MAC address, location ID, location password are removed. MAC address was moved to network interface class. Location ID and password were replaced with new authentication method - via email address and authentication key. You can generate your authentication key in the same way as GUID (it is actually in exactly the same format): </p><div class="fragment"><div class="line">// Generate AUTHKEY from https://www.supla.org/arduino/get-authkey</div>
<div class="line">char AUTHKEY[SUPLA_AUTHKEY_SIZE] =  {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};</div>
</div><!-- fragment --><p>Next change is for custom digitalWrite and digitalRead methods. Those can be used to create virtual digital pins. Instead of adding custom callback method that overrides digitalWrite/Read method, you should create a new class which inhertis from <a class="el" href="classSupla_1_1Io.html">Supla::Io</a> base class and define your own customDigitalRead/Write methods. Here is short example (you can put this code in ino file, before setup()): </p><div class="fragment"><div class="line">#include &lt;supla/io.h&gt;</div>
<div class="line"> </div>
<div class="line">class MyDigitalRead : public Supla::Io {</div>
<div class="line">  public:</div>
<div class="line">    int customDigitalRead(int channelNumber, uint8_t pin) {</div>
<div class="line">      if (channelNumber == MY_EXTRA_VIRTUAL_CHANNEL) {</div>
<div class="line">        return someCustomSourceOfData.getValue();</div>
<div class="line">      } else {</div>
<div class="line">        return ::digitalRead(pin);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">MyDigitalRead instanceMyDigitalRead;</div>
</div><!-- fragment --><p>All channels from old version of library should be removed and created again in a new format. Please check instructions below how to add each type of channel.</p>
<h2><a class="anchor" id="autotoc_md14"></a>
Supported channels</h2>
<h3><a class="anchor" id="autotoc_md15"></a>
Sensors</h3>
<p>Sensor category is for all elements/channels that reads something and provides data to Supla server. All sensors are in <code>Supla::Sensor</code> namespace:</p>
<ul>
<li><code>Binary</code> - two state sensor: on/off, enabled/disabled, open/closesd, etc. It reads GPIO state: LOW/HIGH</li>
<li><code>VirtualBinary</code> - similar to <code>Binary</code> but it use settable variable in memory to show state</li>
<li><code>VirtualThermometer</code> - thermometer channel with settable variable in memory</li>
<li><code>VirtualHygrometer</code> - humidity channel with settable variable in memory</li>
<li><code>VirtualThermHygroPressMeter</code> - thermometer, humidity, and pressure channel with settable variable in memory</li>
<li><code><a class="el" href="classThermometer.html">Thermometer</a></code> - base class for thermometer sensors</li>
<li><code>DS18B20</code> - DS18B20 thermometer</li>
<li><code>Si7021</code> - S17021 thermometer</li>
<li><code>Si7021Sonoff</code> - Si7021 thermometer for Sonoff</li>
<li><code>MAX6675_K</code> - MAX6675_K thermometer</li>
<li><code>MAXThermocouple</code> - MAX6675 and MAX31855 thremocouples (thermometers)</li>
<li><code>NTC10k</code> - NTC10k thermometer</li>
<li><code>ThermHygroMeter</code> - base class for sensors capable of measuring temperature and humidity</li>
<li><code>DHT</code> - DHT11 and DHT22 support</li>
<li><code>SHT3x</code> - SHT3x support</li>
<li><code>AHT</code> - AHT temperature and humidity</li>
<li><code>ThermHygroPressMeter</code> - base class for sensors capable of measuring temperature, humidity, and pressure</li>
<li><code>BME280</code> - BME280 support</li>
<li><code>Distance</code> - base class for distance sensors</li>
<li><code>HC_SR04</code> - HC_SR04, JSN-SR20-Y1 distance meters</li>
<li><code>Pressure</code> - base class for presure meters</li>
<li><code>Wind</code> - base class for wind meters (speed)</li>
<li><code>Rain</code> - base class for rain meters</li>
<li><code><a class="el" href="classWeight.html">Weight</a></code> - base class for weight meters</li>
<li><code><a class="el" href="classImpulseCounter.html">ImpulseCounter</a></code> - calculates impulses on a given GPIO</li>
<li><code><a class="el" href="classElectricityMeter.html">ElectricityMeter</a></code> - base class for electricity meters</li>
<li><code>OnePhaseElectricityMeter</code> - base class for single phase electricity meters</li>
<li><code>PZEMv2</code> - PZEMv2 one phase electricity meter</li>
<li><code>PZEMv3</code> - PZEMv3 one phase electricity meter</li>
<li><code>ThreePhasePZEMv3</code> - 3x PZEMv3 for measuring three phases</li>
<li><code>EspFreeHeap</code> - provides free heap memory on ESP8266 as a <a class="el" href="classChannel.html">Channel</a></li>
<li><code>HX711</code> - HX711 support (weight sensor)</li>
<li><code>HygroMeter</code> - base class for sensors capable of measuring humidity</li>
</ul>
<h3><a class="anchor" id="autotoc_md16"></a>
Control</h3>
<p>Control category is for all elements/channels that are used to control something, i.e. relays, buttons, RGBW. Classes in this category are in namespace <code>Supla::Control</code>:</p>
<ul>
<li><code>ActionTrigger</code> - allows to send Action Triggers to server based on events in application, can be attached to <a class="el" href="classButton.html">Button</a></li>
<li><code>BistableRelay</code> - SuplaDevice sends short impulses on GPIO to trigger change of bistable relay. It requires additional GPIO input to read status of relay</li>
<li><code>BistableRollerShutter</code> - Roller shutter implementation to control external roller shutter controllers that work in a similar way to bistable relays</li>
<li><code><a class="el" href="classButton.html">Button</a></code> - allows to use button connected to GPIO to control other elements in device. Supports multiclicks, long click, etc</li>
<li><code>DimmerBase</code> - base class for dimmers</li>
<li><code>DimmerLeds</code> - PWM based implementation for dimmer</li>
<li><code>InternalPinOutput</code> - allows to control GPIO without showing it to Supla as a channel</li>
<li><code>LightRelay</code> - extension of <a class="el" href="classRelay.html">Relay</a> class that allows to monitor and configure lifespan of light source</li>
<li><code>PinStatusLed</code> - allows to duplicate GPIO state to another GPIO which can have connected LED to show status</li>
<li><code><a class="el" href="classRelay.html">Relay</a></code> - allows to control relay through GPIO</li>
<li><code>RGBBase</code> - base class for RGB control</li>
<li><code>RGBLeds</code> - PWM based implementation for RGB lights</li>
<li><code>RGBWBase</code> - base class for RGBW control</li>
<li><code>RGBWLeds</code> - PWM based implementation for RGBW lights</li>
<li><code>RollerShutter</code> - controller for roller shutters</li>
<li><code>SequenceButton</code> - extension of button which allows to trigger actions based on specific sequence/rythm</li>
<li><code><a class="el" href="classSimpleButton.html">SimpleButton</a></code> - button that allows only press and release detection with lower memory footprint</li>
<li><code>TrippleButtonRollerShutter</code> - roller shutter implementation to control external roller shutter controllers with 3 buttons: up, down, stop</li>
<li><code>VirtualRelay</code> - relay which keeps its state in memory and doesn't affect any GPIO</li>
</ul>
<h3><a class="anchor" id="autotoc_md17"></a>
Photovoltaic inverter</h3>
<p>SuplaDevice provides integrations for following inverters:</p>
<ul>
<li><code>Afore</code></li>
<li><code>Fronius</code></li>
<li><code>SolarEdge</code></li>
</ul>
<h2><a class="anchor" id="autotoc_md18"></a>
Supported persistant memory storage</h2>
<p>Storage class is used as an abstraction for different persistant memory devices. Some elements/channels will not work properly without storage and some will have limitted functionalities. I.e. <code><a class="el" href="classImpulseCounter.html">ImpulseCounter</a></code> requires storage to save counter value, so it could be restored after reset, or <code>RollerShutter</code> requires storage to keep openin/closing times and current shutter possition. Currently two variants of storage classes are supported. </p>
<h3><a class="anchor" id="autotoc_md19"></a>
EEPROM/Flash memory</h3>
<p>EEPROM (in case of Arduino Mega) and Flash (in case of ESP) are build into most of boards. Usually writing should be safe for 100 000 write operations (on each bit). So in order to limit those operations, this kind of Storage will save data in longer time periods (every few minutes). Supla will not write data if there is no change. </p><div class="fragment"><div class="line">#include &lt;supla/storage/eeprom.h&gt;</div>
<div class="line">Supla::Eeprom eeprom(SUPLA_STORAGE_OFFSET);</div>
</div><!-- fragment --><p> Offset parameter is optional - use it if you already use saving to EEPROM in your application and you want SuplaDevice to use some other area of memory.</p>
<h3><a class="anchor" id="autotoc_md20"></a>
Adafruit FRAM SPI</h3>
<p>FRAM is recommended for storage in Supla. It allows almost limitless writing cycles and it is very fast memory. Currently only Adafruit FRAM SPI is supported. </p><div class="fragment"><div class="line">#include &lt;supla/storage/fram_spi.h&gt;</div>
<div class="line">// Hardware SPI</div>
<div class="line">Supla::FramSpi fram(FRAM_CS, SUPLA_STORAGE_OFFSET);</div>
</div><!-- fragment --><p> or with SW SPI: </p><div class="fragment"><div class="line">// Software SPI</div>
<div class="line">Supla::FramSpi fram(SCK_PIN, MISO_PIN, MOSI_PIN, FRAM_CS, SUPLA_STORAGE_OFFSET);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md21"></a>
License</h2>
<p>Please check it <a href="https://github.com/SUPLA/supla-cloud/blob/master/LICENSE">here</a>.</p>
<h1><a class="anchor" id="autotoc_md22"></a>
Installation instructions for ESP IDF and ESP8266 RTOS SDK (draft)</h1>
<h2><a class="anchor" id="autotoc_md23"></a>
ESP32:</h2>
<p><a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started/linux-setup.html">Espressif ESP-IDF SDK installation steps for Linux (Ubuntu)</a> - run below commands: </p><div class="fragment"><div class="line">sudo apt-get install git wget flex bison gperf python3 python3-pip python3-setuptools cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0</div>
<div class="line">mkdir ~/esp</div>
<div class="line">cd ~/esp</div>
<div class="line">git clone --recursive https://github.com/espressif/esp-idf.git</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md24"></a>
ESP8266:</h2>
<p><a href="https://docs.espressif.com/projects/esp8266-rtos-sdk/en/latest/get-started/index.html">Espressif RTOS-SDK ESP-IDF style</a>: Assuming that ESP32 (ESP IDF) installation was already done, run those commands: </p><div class="fragment"><div class="line">sudo apt install gcc git wget make libncurses-dev flex bison gperf python</div>
<div class="line">cd ~/esp</div>
<div class="line">wget https://dl.espressif.com/dl/xtensa-lx106-elf-gcc8_4_0-esp-2020r3-linux-amd64.tar.gz</div>
<div class="line">tar -xzf xtensa-lx106-elf-gcc8_4_0-esp-2020r3-linux-amd64.tar.gz</div>
<div class="line">git clone --recursive https://github.com/espressif/ESP8266_RTOS_SDK.git</div>
<div class="line">/usr/bin/python -m pip install --user -r ~/esp/ESP8266_RTOS_SDK/requirements.txt</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md25"></a>
ESP8266 and ESP32 environement setup:</h2>
<p>Add to <code>~/.profile</code>: </p><div class="fragment"><div class="line"># ESP tools setup options</div>
<div class="line">export ESP_TOOLSET=&quot;none&quot;</div>
<div class="line">alias unload_esp=&#39;export ESP_TOOLSET=&quot;none&quot; &amp;&amp; export PATH=$(echo $PATH | sed -e &quot;s#${HOME}/esp/[^:]*:##g&quot; | sed -e &quot;s#:${HOME}/esp/xtensa-lx106-elf/bin##g&quot;) &amp;&amp; unset IDF_PATH &amp;&amp; unset IDF_PYTHON_ENV_PATH &amp;&amp; unset IDF_TOOLS_EXPORT_CMD &amp;&amp; unset IDF_TOOLS_INSTALL_CMD &amp;&amp; unset IDF_TOOLS_PATH&#39;</div>
<div class="line">alias use_esp8266=&#39;unload_esp &amp;&amp; export PATH=&quot;$PATH:$HOME/esp/xtensa-lx106-elf/bin&quot; &amp;&amp; export ESP_TOOLSET=&quot;esp8266&quot; &amp;&amp; source ~/esp/ESP8266_RTOS_SDK/export.sh&#39;</div>
<div class="line">alias use_esp32=&#39;unload_esp &amp;&amp; export IDF_TOOLS_PATH=~/esp/esp_idf_tools &amp;&amp; export ESP_TOOLSET=&quot;esp32&quot; &amp;&amp; source ~/esp/esp-idf/export.sh&#39;</div>
</div><!-- fragment --><p>This will provide <code>use_esp8266</code> and <code>use_esp32</code> commands on command line. If those commands are not available, then your <code>.profile</code> file wasn't automatically loaded. You can load in manually by calling: <code>source ~/.profile</code></p>
<p>Commands <code>use_esp8266</code> and <code>use_esp32</code> will setup environment for those boards.</p>
<p>Last step is to setup <code>SUPLA_DEVICE_PATH</code> env variable. You can do it from command line: </p><div class="fragment"><div class="line">SUPLA_DEVICE_PATH=/home/your_user_home_folder/path_to/supla-device/</div>
</div><!-- fragment --><p> or you can add this line to <code>.profile</code> file so it will setup it automatically.</p>
<p>Now you can go to <code>extras/examples/</code> directory and select example for ESP8266 or for ESP32:</p>
<h3><a class="anchor" id="autotoc_md26"></a>
ESP8266 example</h3>
<p>Use <code>esp8266_rtos</code> directory (you can copy it to any location and modify). In this folder call:</p>
<p><code>make menuconfig</code> and setup your build (especially select proper USB device for flashing). Then call:</p>
<p><code>make build</code> - for building</p>
<p><code>make flash</code> - for flashing ESP</p>
<p><code>make monitor</code> - to run serial monitor (use CTRL+] to exit)</p>
<h3><a class="anchor" id="autotoc_md27"></a>
ESP32 example</h3>
<p>Use <code>esp_idf</code> directory (you can copy it to any location and modify). In this folder call:</p>
<p><code>idf.py menuconfig</code> and setup your build (especially select proper USB device for flashing). Then call:</p>
<p><code>idf.py build</code> - for building</p>
<p><code>idf.py flash</code> - for flashing ESP</p>
<p><code>idf.py monitor</code> - to run serial monitor (use CTRL+] to exit)</p>
<h2><a class="anchor" id="autotoc_md28"></a>
FreeRTOS installation:</h2>
<p><code>sudo apt install libpcap-dev</code> <code>git clone <a href="https://github.com/FreeRTOS/FreeRTOS.git">https://github.com/FreeRTOS/FreeRTOS.git</a> --recurse-submodules</code> </p>
</div></div><!-- PageDoc -->
<a href="doxygen_crawl.html"></a>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2
</small></address>
</div><!-- doc-content -->
</body>
</html>
